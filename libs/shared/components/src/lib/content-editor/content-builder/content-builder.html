<div class="container">
  <div class="content"
       cdkDropList
       mfTextSelectionPopup
       closestContentObserverClass="mf-content-editor-content-editable"
       [targetComponent]="commandBar"
       (tagSelected)="onTagSelected($event)"
       (cdkDropListDropped)="drop($event)">
    @for (dataBlock of _content(); track dataBlock.id) {
      <div class="block"
           [class.is-focused]="isBlockFocused(dataBlock.id)"
           [class.is-active]="isActiveBlock(dataBlock.id)"
           cdkDrag cdkDragLockAxis="y"
           cdkMonitorSubtreeFocus
           (cdkDragStarted)="onDragStarted($event, dataBlock)"
           (cdkDragEnded)="onDragEnded($event, dataBlock)"
           (cdkFocusChange)="onFocusChange($event, dataBlock)">
        <div class="block-controls">
          <button class="block-control">
            <mat-icon (mousedown)="setActiveBlockId($event, dataBlock.id)"
                      [matMenuTriggerFor]="suggestionsMenu"
                      [matMenuTriggerRestoreFocus]="false"
                      (menuOpened)="onSuggestionsMenuOpen()"
                      (menuClosed)="onSuggestionsMenuClose($event)">add</mat-icon>
          </button>
          <button class="block-control" cdkDragHandle>
            <mat-icon>drag_indicator</mat-icon>
          </button>
        </div>
        <div class="block-content">
          <div class="drag-placeholder" *cdkDragPlaceholder></div>
          <ng-container [ngComponentOutlet]="_blockDefsMap.get(dataBlock.type) | async"
                        [ngComponentOutletInputs]="{
                          id: dataBlock.id,
                          content: dataBlock.content,
                          options: dataBlock.options,
                          index: $index
                        }"/>
        </div>
      </div>
    }
  </div>
</div>
<mat-menu #suggestionsMenu="matMenu">
  <div (click)="preventMenuClose($event)">
    @for (suggestionItem of suggestions(); track $index; let first = $first) {
      @switch (suggestionItem.type) {
        @case ('heading') {
          <div class="font-bold text-3xs px-3 text-neutral-600"
               [class.mt-5]="!first">{{ suggestionItem.title }}</div>
        }
        @case ('item') {
          <button mat-menu-item (click)="addBlockFromSuggestionMenu(suggestionsMenu, suggestionItem.blockType, suggestionItem.blockOptions)">
            <div class="h-full flex items-center gap-3">
              <div class="size-9 flex items-center rounded-lg justify-center bg-surface-container-highest">
                <mat-icon class="!me-0">{{ suggestionItem.iconName }}</mat-icon>
              </div>
              <div class="grow min-w-[200px]">
                <div>{{ suggestionItem.title }}</div>
                <div class="text-3xs text-neutral-600">{{ suggestionItem.description }}</div>
              </div>
              @if (suggestionItem.hotKeys) {
                <div class="ms-auto bg-surface-container-highest rounded-full h-5
                  text-4xs px-2 flex items-center font-bold">{{ suggestionItem.hotKeys }}</div>
              }

            </div>
          </button>
        }
      }
    }
  </div>
</mat-menu>
