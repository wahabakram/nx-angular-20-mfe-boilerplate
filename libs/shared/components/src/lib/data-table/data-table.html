<!-- Modern Data Table Component -->
<div class="mf-data-table card bg-base-100 shadow-sm border border-base-300">

  <!-- Loading Progress Bar -->
  @if (defaultConfig().showProgress && loading()) {
  <mat-progress-bar mode="indeterminate" class="!h-1"></mat-progress-bar>
  }

  <!-- Table Container -->
  <div class="overflow-auto" [class.max-h-96]="!defaultConfig().pagination">
    <table mat-table [dataSource]="dataSource" [class]="'w-full ' + (defaultConfig().density || 'standard')"
      [class.mat-table-sticky-header]="defaultConfig().stickyHeader" matSort>

      <!-- Selection Column -->
      @if (defaultConfig().selectable) {
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef class="!w-12">
          @if (defaultConfig().multiSelect) {
          <mat-checkbox [checked]="selection.hasValue() && isAllSelected()"
            [indeterminate]="selection.hasValue() && !isAllSelected()" (change)="toggleAllRows()"
            [attr.aria-label]="'Select all'">
          </mat-checkbox>
          }
        </th>
        <td mat-cell *matCellDef="let row" class="!w-12">
          <mat-checkbox [checked]="selection.isSelected(row)" (change)="toggleRow(row)"
            [attr.aria-label]="'Select row'">
          </mat-checkbox>
        </td>
      </ng-container>
      }

      <!-- Dynamic Data Columns -->
      @for (column of visibleColumns(); track column.key) {
      <ng-container [matColumnDef]="column.key">
        <th mat-header-cell *matHeaderCellDef [mat-sort-header]="column.sortable ? column.key : ''"
          [style.width]="column.width" [class]="'text-' + (column.align || 'left')"
          [class.sticky-start]="column.sticky === 'start'" [class.sticky-end]="column.sticky === 'end'">
          {{ column.label }}
        </th>
        <td mat-cell *matCellDef="let row" [style.width]="column.width" [class]="'text-' + (column.align || 'left')"
          [class.sticky-start]="column.sticky === 'start'" [class.sticky-end]="column.sticky === 'end'"
          (click)="onRowClick(row)" class="cursor-pointer hover:bg-base-200">

          @if (column.type === 'boolean') {
          <div class="flex items-center">
            <div class="badge badge-sm" [class.badge-success]="getColumnValue(row, column)"
              [class.badge-ghost]="!getColumnValue(row, column)">
              {{ getColumnValue(row, column) ? 'Yes' : 'No' }}
            </div>
          </div>
          } @else if (column.type === 'currency') {
          <span class="font-medium text-success">
            {{ getColumnValue(row, column) }}
          </span>
          } @else if (column.type === 'date') {
          <span class="text-sm text-base-content/70">
            {{ getColumnValue(row, column) }}
          </span>
          } @else {
          <span [innerHTML]="getColumnValue(row, column)"></span>
          }
        </td>
      </ng-container>
      }

      <!-- Actions Column -->
      @if (actions().length > 0) {
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="!w-24 text-center">Actions</th>
        <td mat-cell *matCellDef="let row" class="!w-24">
          <div class="flex items-center justify-center gap-1">
            @for (action of getVisibleActions(row); track action.id) {
            <button class="btn btn-ghost btn-circle btn-sm" [disabled]="isActionDisabled(action, row)"
              [matTooltip]="action.tooltip || action.label"
              (click)="onActionClick(action, row); $event.stopPropagation()">
              @if (action.icon) {
              <mf-icon [name]="action.icon" class="size-4"></mf-icon>
              } @else {
              <mf-icon name="solar:menu-dots-line-duotone" class="size-4"></mf-icon>
              }
            </button>
            }

            <!-- More actions menu if too many actions -->
            <!-- @if (getVisibleActions(row).length > 3) {
            <button class="btn btn-ghost btn-circle btn-sm" [matMenuTriggerFor]="actionsMenu">
              <mf-icon name="solar:menu-dots-line-duotone" class="size-4"></mf-icon>
            </button>
            <mat-menu #actionsMenu="matMenu">
              @for (action of getVisibleActions(row); track action.id) {
              <button mat-menu-item [disabled]="isActionDisabled(action, row)" (click)="onActionClick(action, row)">
                @if (action.icon) {
                <mf-icon [name]="action.icon" class="size-4 mr-2"></mf-icon>
                }
                {{ action.label }}
              </button>
              }
            </mat-menu>
            } -->
          </div>
        </td>
      </ng-container>
      }

      <!-- Table Headers and Rows -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns(); sticky: defaultConfig().stickyHeader"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns();"
        class="hover:bg-base-200/50 transition-colors duration-200" [class.selected]="selection.isSelected(row)"></tr>
    </table>
  </div>

  <!-- Empty State -->
  @if (!hasData() && !loading()) {
  <div class="flex flex-col items-center justify-center py-12 text-center">
    <mf-icon name="solar:box-line-duotone" class="size-16 text-base-content/30 mb-4"></mf-icon>
    <h3 class="text-lg font-medium text-base-content mb-2">No Data Available</h3>
    <p class="text-sm text-base-content/60">{{ defaultConfig().emptyMessage }}</p>
  </div>
  }

  <!-- Loading State -->
  @if (loading() && !hasData()) {
  <div class="flex flex-col items-center justify-center py-12">
    <div class="loading loading-spinner loading-lg text-primary mb-4"></div>
    <p class="text-sm text-base-content/60">Loading data...</p>
  </div>
  }

  <!-- Pagination -->
  @if (defaultConfig().pagination && hasData()) {
  <div class="border-t border-base-300 p-4">
    <mat-paginator [pageSizeOptions]="defaultConfig().pageSizeOptions || [10, 25, 50, 100]"
      [pageSize]="defaultConfig().pageSize || 25" [showFirstLastButtons]="true" [length]="dataSource.data.length"
      (page)="pageChange.emit($event)" class="!bg-transparent">
    </mat-paginator>
  </div>
  }

  <!-- Footer Info -->
  @if (hasData()) {
  <div class="border-t border-base-300 px-4 py-2 bg-base-50">
    <div class="flex items-center justify-between text-xs text-base-content/60">
      <span>
        @if (selection.hasValue()) {
        {{ selection.selected.length }} of {{ dataSource.data.length }} selected
        } @else {
        {{ dataSource.data.length }} total records
        }
      </span>

      @if (defaultConfig().density) {
      <span class="badge badge-ghost badge-xs">{{ defaultConfig().density }}</span>
      }
    </div>
  </div>
  }
</div>