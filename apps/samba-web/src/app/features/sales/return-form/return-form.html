<app-page>
  <ng-container pageTitle>Process Customer Return</ng-container>
  <ng-container pageDescription>Process product returns and issue refunds</ng-container>

  <form [formGroup]="returnForm" (ngSubmit)="onSubmit()" class="max-w-6xl">
    <!-- Error Message -->
    @if (error()) {
    <div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
      <div class="flex items-center gap-2 text-red-800 dark:text-red-200">
        <mf-icon name="solar:danger-circle-line-duotone" />
        <span class="font-medium">{{ error() }}</span>
      </div>
    </div>
    }

    <!-- Sale Selection -->
    <div class="bg-white dark:bg-neutral-900 rounded-lg border border-neutral-200 dark:border-neutral-800 p-6 mb-6">
      <h3 class="text-lg font-semibold mb-4">Select Original Sale</h3>

      <div class="flex gap-4 items-end">
        <mat-form-field class="flex-1">
          <mat-label>Sale Number</mat-label>
          <input matInput formControlName="saleNumber" placeholder="e.g., SALE-2024-00123" />
          @if (returnForm.get('saleNumber')?.hasError('required') && returnForm.get('saleNumber')?.touched) {
          <mat-error>Sale number is required</mat-error>
          }
        </mat-form-field>

        @if (!selectedSale()) {
        <button type="button" mat-raised-button color="primary" (click)="searchSale()" [disabled]="isLoading()">
          @if (isLoading()) {
          <mat-progress-spinner diameter="20" mode="indeterminate" class="inline-block"></mat-progress-spinner>
          } @else {
          <mf-icon name="solar:magnifer-line-duotone" />
          }
          Search
        </button>
        } @else {
        <button type="button" mat-raised-button color="warn" (click)="clearSale()">
          <mf-icon name="solar:close-circle-line-duotone" />
          Clear
        </button>
        }
      </div>

      <!-- Selected Sale Info -->
      @if (selectedSale()) {
      <div class="mt-4 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
          <div>
            <span class="text-neutral-500">Sale Number:</span>
            <span class="ml-2 font-medium">{{ selectedSale()!.receiptNumber }}</span>
          </div>
          <div>
            <span class="text-neutral-500">Date:</span>
            <span class="ml-2 font-medium">{{ selectedSale()!.saleDate | date:'short' }}</span>
          </div>
          <div>
            <span class="text-neutral-500">Total:</span>
            <span class="ml-2 font-medium">Rs {{ selectedSale()!.totalAmount | number:'1.2-2' }}</span>
          </div>
        </div>
      </div>
      }
    </div>

    <!-- Return Items -->
    @if (selectedSale() && returnItems().length > 0) {
    <div class="bg-white dark:bg-neutral-900 rounded-lg border border-neutral-200 dark:border-neutral-800 p-6 mb-6">
      <h3 class="text-lg font-semibold mb-4">Select Items to Return</h3>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b border-neutral-200 dark:border-neutral-700">
              <th class="text-left py-3 px-2 text-sm font-medium text-neutral-500">Select</th>
              <th class="text-left py-3 px-4 text-sm font-medium text-neutral-500">Product</th>
              <th class="text-right py-3 px-4 text-sm font-medium text-neutral-500">Sold Qty</th>
              <th class="text-right py-3 px-4 text-sm font-medium text-neutral-500">Return Qty</th>
              <th class="text-left py-3 px-4 text-sm font-medium text-neutral-500">Reason</th>
              <th class="text-right py-3 px-4 text-sm font-medium text-neutral-500">Unit Price</th>
              <th class="text-right py-3 px-4 text-sm font-medium text-neutral-500">Refund Amount</th>
            </tr>
          </thead>
          <tbody>
            @for (item of returnItems(); track $index) {
            <tr class="border-b border-neutral-100 dark:border-neutral-800">
              <td class="py-3 px-2">
                <mat-checkbox [checked]="item.selected" (change)="toggleItemSelection($index)"></mat-checkbox>
              </td>
              <td class="py-3 px-4">
                <div class="font-medium">{{ item.saleItem.product?.name || 'Product' }}</div>
                @if (item.saleItem.product?.sku) {
                <div class="text-xs text-neutral-500">SKU: {{ item.saleItem.product?.sku }}</div>
                }
              </td>
              <td class="text-right py-3 px-4">{{ item.maxQuantity }}</td>
              <td class="py-3 px-4">
                @if (item.selected) {
                <input type="number" [(ngModel)]="item.returnQuantity" [ngModelOptions]="{standalone: true}"
                  (ngModelChange)="onQuantityChange($index)" [max]="item.maxQuantity" min="1"
                  class="w-20 px-2 py-1 border border-neutral-300 dark:border-neutral-600 rounded text-right" />
                } @else {
                <span class="text-neutral-400">-</span>
                }
              </td>
              <td class="py-3 px-4">
                @if (item.selected) {
                <select [(ngModel)]="item.reason" [ngModelOptions]="{standalone: true}"
                  (change)="onReasonChange($index, $event)"
                  class="w-full px-2 py-1 border border-neutral-300 dark:border-neutral-600 rounded text-sm">
                  <option value="">Select reason</option>
                  @for (reason of returnReasons; track reason.value) {
                  <option [value]="reason.value">{{ reason.label }}</option>
                  }
                </select>
                } @else {
                <span class="text-neutral-400">-</span>
                }
              </td>
              <td class="text-right py-3 px-4">Rs {{ item.saleItem.unitPrice | number:'1.2-2' }}</td>
              <td class="text-right py-3 px-4 font-medium">
                @if (item.selected) {
                Rs {{ item.subtotal | number:'1.2-2' }}
                } @else {
                <span class="text-neutral-400">-</span>
                }
              </td>
            </tr>
            }
          </tbody>
          <tfoot>
            <tr class="font-semibold">
              <td colspan="6" class="text-right py-4 px-4">Total Refund Amount:</td>
              <td class="text-right py-4 px-4 text-lg text-primary">
                Rs {{ totalRefundAmount() | number:'1.2-2' }}
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Refund Details -->
    <div class="bg-white dark:bg-neutral-900 rounded-lg border border-neutral-200 dark:border-neutral-800 p-6 mb-6">
      <h3 class="text-lg font-semibold mb-4">Refund Details</h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <mat-form-field class="w-full">
          <mat-label>Refund Method</mat-label>
          <mat-select formControlName="refundMethod">
            @for (method of refundMethods; track method.value) {
            <mat-option [value]="method.value">{{ method.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field class="w-full">
          <mat-label>Notes (Optional)</mat-label>
          <input matInput formControlName="notes" placeholder="Additional notes about this return" />
        </mat-form-field>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex gap-3">
      <button type="submit" mat-raised-button color="primary" [disabled]="isSaving() || !selectedSale() || selectedItems().length === 0">
        @if (isSaving()) {
        <mat-progress-spinner diameter="20" mode="indeterminate" class="inline-block"></mat-progress-spinner>
        Processing...
        } @else {
        <mf-icon name="solar:check-circle-line-duotone" />
        Process Return
        }
      </button>
      <button type="button" mat-button (click)="cancel()">
        Cancel
      </button>
    </div>
    }

    <!-- Empty State -->
    @if (!selectedSale()) {
    <div class="text-center py-12">
      <mf-icon name="solar:bill-list-line-duotone" class="size-16 mx-auto mb-4 text-neutral-400" />
      <p class="text-neutral-500">Enter a sale number above to start processing a return</p>
    </div>
    }
  </form>
</app-page>
