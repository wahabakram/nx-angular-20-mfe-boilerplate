<app-page>
  <ng-container pageTitle>{{ isEditMode() ? 'Edit Product' : 'Add New Product' }}</ng-container>
  <ng-container pageDescription>{{ isEditMode() ? 'Update product information' : 'Add a new product to your inventory' }}</ng-container>
  <ng-container pageActions>
    <button mat-stroked-button type="button" (click)="onCancel()" [disabled]="isLoading()">
      Cancel
    </button>
    <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="isLoading() || productForm.invalid">
      @if (isLoading()) {
        <mat-spinner diameter="20" class="mr-2"></mat-spinner>
      }
      {{ isEditMode() ? 'Update Product' : 'Create Product' }}
    </button>
  </ng-container>

  @if (error()) {
    <mat-card class="mb-6 bg-error-50 text-error border-l-4 border-error">
      <mat-card-content class="p-4">
        <div class="flex items-center">
          <mat-icon class="mr-2">error</mat-icon>
          <span>{{ error() }}</span>
        </div>
      </mat-card-content>
    </mat-card>
  }

  <mat-card>
    <mat-card-content class="p-6">
      <form [formGroup]="productForm">
        <!-- Basic Information -->
        <div class="mb-6">
          <h3 class="text-lg font-medium mb-4">Basic Information</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <mat-form-field class="w-full">
              <mat-label>Product Name</mat-label>
              <input matInput formControlName="name" required>
              @if (hasError('name', 'required')) {
                <mat-error>{{ getErrorMessage('name') }}</mat-error>
              }
              @if (hasError('name', 'minlength')) {
                <mat-error>{{ getErrorMessage('name') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field class="w-full">
              <mat-label>SKU</mat-label>
              <input matInput formControlName="sku" required>
              @if (hasError('sku', 'required')) {
                <mat-error>{{ getErrorMessage('sku') }}</mat-error>
              }
              @if (hasError('sku', 'minlength')) {
                <mat-error>{{ getErrorMessage('sku') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field class="w-full">
              <mat-label>Barcode</mat-label>
              <input matInput formControlName="barcode" placeholder="Optional">
            </mat-form-field>

            <mat-form-field class="w-full">
              <mat-label>Status</mat-label>
              <mat-select formControlName="status" required>
                @for (status of statusOptions; track status.value) {
                  <mat-option [value]="status.value">{{ status.label }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <mat-form-field class="w-full">
            <mat-label>Description</mat-label>
            <textarea matInput formControlName="description" rows="3" placeholder="Optional"></textarea>
          </mat-form-field>
        </div>

        <!-- Pricing -->
        <div class="mb-6">
          <h3 class="text-lg font-medium mb-4">Pricing</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <mat-form-field class="w-full">
              <mat-label>Selling Price</mat-label>
              <input matInput type="number" formControlName="price" required min="0" step="0.01">
              <span matTextPrefix>$&nbsp;</span>
              @if (hasError('price', 'required')) {
                <mat-error>{{ getErrorMessage('price') }}</mat-error>
              }
              @if (hasError('price', 'min')) {
                <mat-error>{{ getErrorMessage('price') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field class="w-full">
              <mat-label>Cost Price</mat-label>
              <input matInput type="number" formControlName="costPrice" required min="0" step="0.01">
              <span matTextPrefix>$&nbsp;</span>
              @if (hasError('costPrice', 'required')) {
                <mat-error>{{ getErrorMessage('costPrice') }}</mat-error>
              }
              @if (hasError('costPrice', 'min')) {
                <mat-error>{{ getErrorMessage('costPrice') }}</mat-error>
              }
            </mat-form-field>
          </div>
        </div>

        <!-- Inventory Management -->
        <div class="mb-6">
          <h3 class="text-lg font-medium mb-4">Inventory Management</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <mat-form-field class="w-full">
              <mat-label>Current Stock Level</mat-label>
              <input matInput type="number" formControlName="stockLevel" required min="0">
              @if (hasError('stockLevel', 'required')) {
                <mat-error>{{ getErrorMessage('stockLevel') }}</mat-error>
              }
              @if (hasError('stockLevel', 'min')) {
                <mat-error>{{ getErrorMessage('stockLevel') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field class="w-full">
              <mat-label>Unit</mat-label>
              <mat-select formControlName="unit" required>
                @for (unit of unitOptions; track unit.value) {
                  <mat-option [value]="unit.value">{{ unit.label }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field class="w-full">
              <mat-label>Low Stock Threshold</mat-label>
              <input matInput type="number" formControlName="lowStockThreshold" required min="0">
              @if (hasError('lowStockThreshold', 'required')) {
                <mat-error>{{ getErrorMessage('lowStockThreshold') }}</mat-error>
              }
              @if (hasError('lowStockThreshold', 'min')) {
                <mat-error>{{ getErrorMessage('lowStockThreshold') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field class="w-full">
              <mat-label>Reorder Point</mat-label>
              <input matInput type="number" formControlName="reorderPoint" required min="0">
              @if (hasError('reorderPoint', 'required')) {
                <mat-error>{{ getErrorMessage('reorderPoint') }}</mat-error>
              }
              @if (hasError('reorderPoint', 'min')) {
                <mat-error>{{ getErrorMessage('reorderPoint') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field class="w-full">
              <mat-label>Maximum Stock Level</mat-label>
              <input matInput type="number" formControlName="maxStockLevel" required min="0">
              @if (hasError('maxStockLevel', 'required')) {
                <mat-error>{{ getErrorMessage('maxStockLevel') }}</mat-error>
              }
              @if (hasError('maxStockLevel', 'min')) {
                <mat-error>{{ getErrorMessage('maxStockLevel') }}</mat-error>
              }
            </mat-form-field>
          </div>
        </div>

        <!-- Additional Information -->
        <div class="mb-6">
          <h3 class="text-lg font-medium mb-4">Additional Information</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <mat-form-field class="w-full">
              <mat-label>Category ID</mat-label>
              <input matInput type="number" formControlName="categoryId" required>
              @if (hasError('categoryId', 'required')) {
                <mat-error>{{ getErrorMessage('categoryId') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field class="w-full">
              <mat-label>Supplier ID</mat-label>
              <input matInput type="number" formControlName="supplierId" placeholder="Optional">
            </mat-form-field>
          </div>
        </div>

        <!-- Product Image -->
        <div class="mb-6">
          <h3 class="text-lg font-medium mb-4">Product Image</h3>
          <app-image-upload
            [imageUrl]="productForm.get('imageUrl')?.value ?? null"
            (imageUrlChange)="productForm.patchValue({ imageUrl: $event ?? undefined })">
          </app-image-upload>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</app-page>
