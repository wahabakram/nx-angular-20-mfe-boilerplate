<app-page>
  <ng-container pageTitle>Point of Sale</ng-container>
  <ng-container pageDescription>Process customer transactions</ng-container>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <!-- Left Panel - Product Search & Cart -->
    <div class="lg:col-span-2">
      @if (error()) {
        <mat-card class="mb-4 bg-error-50 text-error border-l-4 border-error">
          <mat-card-content class="p-4">
            <div class="flex items-center">
              <mf-icon class="mr-2" name="solar:danger-circle-line-duotone" />
              <span>{{ error() }}</span>
            </div>
          </mat-card-content>
        </mat-card>
      }

      <!-- Barcode Scanner / Product Search -->
      <mat-card class="mb-4">
        <mat-card-content class="p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <mf-icon class="text-primary" name="solar:qr-code-line-duotone" />
              <span class="text-sm font-medium">Product Search</span>
            </div>
            @if (barcodeScanner.isListening()) {
              <div class="flex items-center gap-2 text-xs text-success">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-success opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-success"></span>
                </span>
                <span>Scanner Active</span>
              </div>
            }
          </div>
          <div class="flex gap-2">
            <mat-form-field class="flex-1">
              <mat-label>Scan Barcode or Search Product</mat-label>
              <input
                matInput
                [(ngModel)]="searchTerm"
                (keyup.enter)="searchProduct(searchTerm())"
                (input)="filterProducts(searchTerm())"
                placeholder="Enter barcode or product name"
                data-barcode-enabled="true"
                autoFocus
              >
              <mf-icon matPrefix name="solar:magnifer-line-duotone" />
              <button 
                mat-icon-button 
                matSuffix 
                [matTooltip]="barcodeScanner.isListening() ? 'Barcode scanner is active' : 'Barcode scanner is inactive'"
                [class.text-success]="barcodeScanner.isListening()"
                [class.text-neutral-400]="!barcodeScanner.isListening()">
                <mf-icon name="solar:qr-code-line-duotone" />
              </button>
            </mat-form-field>
            <button mat-raised-button color="primary" (click)="searchProduct(searchTerm())">
              <mf-icon name="solar:magnifer-line-duotone" />
              Search
            </button>
          </div>
          <div class="text-xs text-neutral-500 mt-2">
            <mf-icon class="!text-xs align-middle mr-1" name="solar:info-circle-line-duotone" />
            Tip: Use your USB barcode scanner to instantly add products to cart
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Quick Product Selection -->
      @if (filteredProducts().length > 0 && searchTerm()) {
        <mat-card class="mb-4">
          <mat-card-content class="p-4">
            <h3 class="text-sm font-semibold mb-3 text-neutral-600">Quick Select</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-60 overflow-y-auto">
              @for (product of filteredProducts().slice(0, 9); track product.id) {
                <button
                  class="flex items-center gap-2 p-2 border rounded-lg hover:bg-surface-container transition-colors text-left"
                  [class.opacity-50]="product.stockLevel <= 0"
                  [disabled]="product.stockLevel <= 0"
                  (click)="addToCart(product)">
                  <div class="w-10 h-10 rounded bg-surface-container flex items-center justify-center flex-shrink-0 overflow-hidden">
                    @if (product.imageUrl) {
                      <img [src]="product.imageUrl" [alt]="product.name" class="w-full h-full object-cover">
                    } @else {
                      <mf-icon class="text-neutral-400 !text-base" name="solar:box-minimalistic-line-duotone" />
                    }
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium truncate">{{ product.name }}</div>
                    <div class="text-xs text-success font-semibold">${{ product.price.toFixed(2) }}</div>
                    @if (product.stockLevel <= 0) {
                      <div class="text-xs text-error">Out of stock</div>
                    } @else {
                      <div class="text-xs text-neutral-500">Stock: {{ product.stockLevel }}</div>
                    }
                  </div>
                </button>
              }
            </div>
          </mat-card-content>
        </mat-card>
      }

      <!-- Shopping Cart -->
      <mat-card>
        <mat-card-content class="p-4">
          <h3 class="text-lg font-semibold mb-4">Shopping Cart</h3>

          @if (cart().length === 0) {
            <div class="text-center py-12 text-neutral-500">
              <mf-icon class="text-6xl mb-2" name="solar:cart-large-2-line-duotone" />
              <p>Cart is empty</p>
              <p class="text-sm">Scan or search products to add them</p>
            </div>
          } @else {
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="border-b">
                    <th class="text-left py-2">Product</th>
                    <th class="text-center py-2">Price</th>
                    <th class="text-center py-2">Quantity</th>
                    <th class="text-right py-2">Subtotal</th>
                    <th class="text-center py-2">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of cart(); track item.product.id) {
                    <tr class="border-b">
                      <td class="py-3">
                        <div class="flex items-center gap-3">
                          <div class="w-12 h-12 rounded bg-surface-container flex items-center justify-center flex-shrink-0 overflow-hidden">
                            @if (item.product.imageUrl) {
                              <img [src]="item.product.imageUrl" [alt]="item.product.name" class="w-full h-full object-cover">
                            } @else {
                              <mf-icon class="text-neutral-400" name="solar:box-minimalistic-line-duotone" />
                            }
                          </div>
                          <div>
                            <div class="font-medium">{{ item.product.name }}</div>
                            <div class="text-sm text-neutral-600">{{ item.product.sku }}</div>
                          </div>
                        </div>
                      </td>
                      <td class="text-center">${{ item.product.price.toFixed(2) }}</td>
                      <td class="text-center">
                        <div class="flex items-center justify-center gap-2">
                          <button
                            mat-icon-button
                            (click)="updateQuantity(item.product.id, item.quantity - 1)"
                            [disabled]="item.quantity <= 1"
                          >
                            <mf-icon name="solar:minus-circle-line-duotone" />
                          </button>
                          <input
                            type="number"
                            [(ngModel)]="item.quantity"
                            (change)="updateQuantity(item.product.id, item.quantity)"
                            class="w-16 text-center border rounded"
                            min="1"
                            [max]="item.product.stockLevel"
                          >
                          <button
                            mat-icon-button
                            (click)="updateQuantity(item.product.id, item.quantity + 1)"
                            [disabled]="item.quantity >= item.product.stockLevel"
                          >
                            <mf-icon name="solar:add-circle-line-duotone" />
                          </button>
                        </div>
                        <div class="text-xs text-neutral-600 mt-1">
                          Stock: {{ item.product.stockLevel }}
                        </div>
                      </td>
                      <td class="text-right font-medium">${{ item.subtotal.toFixed(2) }}</td>
                      <td class="text-center">
                        <button
                          mat-icon-button
                          color="warn"
                          (click)="removeFromCart(item.product.id)"
                        >
                          <mf-icon name="solar:trash-bin-minimalistic-line-duotone" />
                        </button>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>

            <div class="mt-4 flex justify-end">
              <button mat-stroked-button color="warn" (click)="clearCart()">
                <mf-icon name="solar:close-circle-line-duotone" />
                Clear Cart
              </button>
            </div>
          }
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Right Panel - Payment & Summary -->
    <div class="lg:col-span-1">
      <mat-card class="sticky top-4">
        <mat-card-content class="p-4">
          <h3 class="text-lg font-semibold mb-4">Payment Summary</h3>

          <!-- Summary Details -->
          <div class="space-y-3 mb-4">
            <div class="flex justify-between">
              <span class="text-neutral-600">Subtotal:</span>
              <span class="font-medium">${{ subtotal().toFixed(2) }}</span>
            </div>

            <mf-h-divider></mf-h-divider>

            <!-- Discount -->
            <div>
              <label class="text-sm text-neutral-600">Discount (%)</label>
              <mat-form-field class="w-full">
                <input
                  matInput
                  type="number"
                  [(ngModel)]="discountRate"
                  (ngModelChange)="calculateTotals()"
                  min="0"
                  max="100"
                  placeholder="0"
                >
              </mat-form-field>
            </div>
            @if (discountAmount() > 0) {
              <div class="flex justify-between text-success">
                <span>Discount Amount:</span>
                <span>-${{ discountAmount().toFixed(2) }}</span>
              </div>
            }

            <mf-h-divider></mf-h-divider>

            <!-- Tax -->
            <div class="flex justify-between">
              <span class="text-neutral-600">Tax ({{ (taxRate() * 100).toFixed(0) }}%):</span>
              <span>${{ taxAmount().toFixed(2) }}</span>
            </div>

            <mf-h-divider></mf-h-divider>

            <!-- Total -->
            <div class="flex justify-between text-xl font-bold">
              <span>Total:</span>
              <span class="text-primary">${{ total().toFixed(2) }}</span>
            </div>
          </div>

          <mf-h-divider></mf-h-divider>

          <!-- Payment Method -->
          <div class="mt-4 mb-4">
            <label class="text-sm font-medium mb-2 block">Payment Method</label>
            <mat-form-field class="w-full">
              <mat-select [(ngModel)]="selectedPaymentMethod">
                @for (method of paymentMethods; track method.value) {
                  <mat-option [value]="method.value">
                    {{ method.label }}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Notes -->
          <div class="mb-4">
            <label class="text-sm font-medium mb-2 block">Notes (Optional)</label>
            <mat-form-field class="w-full">
              <textarea
                matInput
                [(ngModel)]="customerNotes"
                rows="2"
                placeholder="Add notes about this sale"
              ></textarea>
            </mat-form-field>
          </div>

          <!-- Complete Sale Button -->
          <button
            mat-raised-button
            color="primary"
            class="w-full py-3"
            (click)="completeSale()"
            [disabled]="cart().length === 0 || isProcessing()"
          >
            @if (isProcessing()) {
              <mat-spinner diameter="20" class="mr-2"></mat-spinner>
            }
            @if (!isProcessing()) {
              <mf-icon name="solar:check-circle-line-duotone" />
            }
            Complete Sale
          </button>
        </mat-card-content>
      </mat-card>

      <!-- Quick Stats -->
      <mat-card class="mt-4">
        <mat-card-content class="p-4">
          <h4 class="font-semibold mb-2">Today's Sales</h4>
          <div class="text-2xl font-bold text-primary">
            ${{ (saleStore.todayRevenue() || 0).toFixed(2) }}
          </div>
          <div class="text-sm text-neutral-600">
            {{ saleStore.todaySales()?.length || 0 }} transactions
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</app-page>
